<!-- REPLACE WHOLE FILE: /tools/nxphuong-importer.html -->
<!-- MXD-TOOL v4.4.0-nxp (tiki support + defaults + aff-detector + safe templates) -->
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NXP Importer v4.4.0 ‚Äî PRO + Batch + Featured + Debug</title>
  <meta name="robots" content="noindex,follow"/>
  <style>
    :root{
      --bg:#f6f7fb; --fg:#0d1a2a; --muted:#4b5b70; --b:#ffffff; --line:#e4e8f1; --accent:#2563eb;
      --ok:#16a34a; --warn:#f59e0b; --err:#ef4444; --toast-bottom:12px;
    }
    body.dark{
      --bg:#0b0f14; --fg:#e8f0fb; --muted:#a7b4c2; --b:#152132; --line:#223348; --accent:#7cc4ff;
      --ok:#34d399; --warn:#f59e0b; --err:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    h1,h2{margin:16px 0 8px}
    h1{font-size:20px}
    h2{font-size:16px;color:var(--accent)}
    a{color:var(--accent)}
    .wrap{max-width:1160px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:1fr 1fr}
    .card{background:var(--b);border:1px solid var(--line);border-radius:12px;padding:14px}
    label{display:block;font-weight:700;margin:8px 0 6px}
    input,select,textarea,button{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#fff;color:#111}
    body.dark input,body.dark select,body.dark textarea{background:#0f1622;color:var(--fg);border-color:#2b3b52}
    textarea{min-height:70px;resize:vertical}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .row>*{flex:1}
    .small{font-size:12px;color:var(--muted)}
    .btn{cursor:pointer;border:1px solid var(--line);background:#eef2ff}
    .btn:hover{background:#e3e9ff}
    body.dark .btn{background:#102235;border-color:#2b3b52}
    body.dark .btn:hover{background:#132a43}
    .btn.primary{background:#2563eb;color:#fff;border-color:#2563eb}
    .btn.primary:hover{filter:brightness(0.98)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line)}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    .drop{border:2px dashed var(--line);border-radius:12px;padding:16px;text-align:center;background:#fafbff}
    body.dark .drop{background:#0c1623;border-color:#3a5270}
    .drop.dragover{border-color:var(--accent)}
    .preview{display:flex;gap:12px;align-items:center}
    .preview img{width:96px;height:96px;object-fit:cover;border-radius:10px;border:1px solid var(--line)}
    .toast{position:fixed;right:12px;bottom:var(--toast-bottom);display:none;max-width:520px;background:var(--b);border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:0 10px 30px #0008;z-index:99999;pointer-events:none}
    .toast.show{display:block}
    code.inline{background:#eef2ff;border:1px solid var(--line);border-radius:6px;padding:2px 6px}
    .badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:11px}
    table.queue{width:100%;border-collapse:separate;border-spacing:0 8px}
    table.queue th, table.queue td{font-size:13px;vertical-align:middle}
    table.queue th{text-align:left;padding:6px 8px}
    table.queue td{background:#fafbff;border:1px solid var(--line);padding:6px 8px}
    body.dark table.queue td{background:#0d1826;border-color:#23364b}
    table.queue td:first-child{border-radius:10px 0 0 10px}
    table.queue td:last-child{border-radius:0 10px 10px 0}
    .thumb{width:56px;height:56px;border-radius:8px;object-fit:cover;border:1px solid var(--line);background:#fff}
    .mini{display:flex;gap:6px;align-items:center}
    .w-auto{width:auto}
    .nowrap{white-space:nowrap}
    .btn.sm{padding:6px 10px;border-radius:8px}
    .controls{display:flex;gap:6px;flex-wrap:wrap}
    .status{font-size:12px}
    .muted{color:var(--muted)}
    .sticky-actions{position:sticky;bottom:0;background:linear-gradient(0deg,var(--bg) 60%,#0000);padding:12px;border-top:1px solid var(--line);z-index:9}
    .topbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px}
    .mode{width:auto}
    .warnbar{background:#fff5f5;border:1px solid #fecaca;color:#991b1b;border-radius:10px;padding:8px 10px;font-size:13px;margin:-6px 0 8px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <h1 id="title">NXP Importer v4.4.0 <span class="pill">PRO</span> <span class="pill">Batch</span> <span class="pill">Featured</span> <span class="pill">Debug</span></h1>
    <div class="row w-auto" style="gap:6px">
      <button id="btnMode" class="btn mode" type="button">Dark mode</button>
      <button id="btnClearFormQuick" class="btn mode" type="button">üßπ Xo√° form</button>
      <button id="btnClearLog" class="btn mode" type="button">üßº Xo√° log</button>
    </div>
  </div>

  <div id="affWarn" class="warnbar" style="display:none">‚ö†Ô∏è Ch∆∞a c·∫•u h√¨nh template affiliate ƒë√∫ng site n√†y. V√†o <b>C√†i ƒë·∫∑t</b> ‚Üí b·∫•m <b>T·ª± ƒë·ªông l·∫•y t·ª´ mxd-affiliate.js</b> ho·∫∑c d√°n th·ªß c√¥ng template Shopee/Lazada/Tiki/TikTok, r·ªìi <b>L∆∞u</b>.</div>

  <div class="card">
    <h2>1) C√†i ƒë·∫∑t</h2>
    <div class="grid g2">
      <div><label>Worker Base URL</label><input id="workerUrl" placeholder="https://&lt;worker&gt;.&lt;account&gt;.workers.dev"/></div>
      <div><label>X-Key (header b·∫£o v·ªá Worker)</label><input id="xKey" placeholder="V√≠ d·ª•: nxp-2025-super"/></div>
    </div>

    <label>Template Shopee</label>
    <input id="tplShopee" placeholder="https://go.isclix.com/deep_link/&lt;AFF_ID&gt;/4751584435713464237?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}"/>

    <label>Template Lazada</label>
    <input id="tplLazada" placeholder="https://go.isclix.com/deep_link/&lt;AFF_ID&gt;/5127144557053758578?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}"/>

    <label>Template Tiki</label>
    <input id="tplTiki" placeholder="https://go.isclix.com/deep_link/&lt;AFF_ID&gt;/4348614231480407268?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}"/>

    <label>Template TikTok</label>
    <input id="tplTiktok" placeholder="https://go.isclix.com/deep_link/&lt;AFF_ID&gt;/6648523843406889655?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}"/>

    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnDetectAff">T·ª± ƒë·ªông l·∫•y t·ª´ /assets/mxd-affiliate.js</button>
      <span class="small" id="affStatus"></span>
    </div>

    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnSaveSettings">üíæ L∆∞u</button>
      <button class="btn" id="btnLoadSettings">‚Üª T·∫£i</button>
      <button class="btn" id="btnClearSettings">üóë Xo√° c√†i ƒë·∫∑t</button>
      <span class="small" id="settingsStatus"></span>
    </div>

    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnCheckWorker">Ki·ªÉm tra Worker</button>
      <button class="btn" id="btnCheckAuth">Ki·ªÉm tra X-Key</button>
      <button class="btn" id="btnCheckWrite">Ki·ªÉm tra quy·ªÅn commit</button>
      <button class="btn" id="btnTestUpload">Test upload 1√ó1</button>
      <span class="small" id="workerStatus"></span>
    </div>
  </div>

  <div class="grid g2">
    <div class="card">
      <h2>2) ·∫¢nh s·∫£n ph·∫©m (ƒë∆°n l·∫ª)</h2>
      <div id="drop" class="drop">K√©o <b>m·ªôt ho·∫∑c nhi·ªÅu</b> ·∫£nh v√†o ƒë√¢y ho·∫∑c ch·ªçn‚Ä¶</div>
      <input type="file" id="file" accept="image/*" multiple style="display:none"/>
      <div class="row" style="margin-top:10px">
        <label class="w-auto" style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="cbUseFilename" checked style="width:auto"/>
          D√πng <b>t√™n file</b> n·∫øu <b>SKU tr·ªëng</b>
        </label>
        <div class="w-auto">
          <label class="small" style="margin:0 0 4px">Th∆∞ m·ª•c m·∫∑c ƒë·ªãnh</label>
          <select id="defaultFolder">
            <option value="/assets/img/products/">/assets/img/products/</option>
            <option value="/assets/img/categories/">/assets/img/categories/</option>
            <option value="/assets/img/og/">/assets/img/og/</option>
            <option value="/assets/img/brands/">/assets/img/brands/</option>
            <option value="custom">T·ª± nh·∫≠p‚Ä¶</option>
          </select>
        </div>
        <div id="defaultCustomWrap" class="w-auto" style="display:none;min-width:280px">
          <label class="small" style="margin:0 0 4px">ƒê∆∞·ªùng d·∫´n tu·ª≥ ch·ªânh (k·∫øt th√∫c b·∫±ng /)</label>
          <input id="defaultCustomPath" placeholder="/assets/img/blog/2025/"/>
        </div>
        <div class="w-auto">
          <label class="small" style="margin:0 0 4px">ƒê·ªãnh d·∫°ng xu·∫•t m·∫∑c ƒë·ªãnh</label>
          <select id="defaultFmt">
            <option value="webp">webp</option>
            <option value="png">png</option>
          </select>
        </div>
      </div>

      <div id="imgPreview" class="preview" style="margin-top:10px;display:none">
        <img id="thumb" alt="preview"/>
        <div class="small">
          <div><b>T√™n file ƒë·ªÅ xu·∫•t:</b> <code class="inline" id="imgName">-</code></div>
          <div><b>K√≠ch th∆∞·ªõc:</b> <span id="imgInfo">-</span></div>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnSelectImg">Ch·ªçn ·∫£nh</button>
        <button class="btn" id="btnConvert">N√©n .webp</button>
        <button class="btn" id="btnSaveImg">T·∫£i ·∫£nh (.webp)</button>
        <button class="btn primary" id="btnUploadImg">Upload ·∫£nh ‚Üí /assets/img/products/&lt;sku&gt;.webp</button>
        <button class="btn" id="btnQueueCurrent">‚ûï Th√™m ·∫£nh hi·ªán t·∫°i v√†o h√†ng ƒë·ª£i</button>
      </div>
      <div class="small">Chu·∫©n: c·∫°nh d√†i ~1200px, WebP q=0.82. N√∫t ‚ûï s·∫Ω ƒë·∫©y ·∫£nh hi·ªán t·∫°i v√†o H√ÄNG ƒê·ª¢I.</div>
    </div>

    <div class="card">
      <h2>3) Th√¥ng tin s·∫£n ph·∫©m</h2>
      <div class="grid">
        <div class="row">
          <div><label>T√™n s·∫£n ph·∫©m</label><input id="name" data-clear placeholder="V√≠ d·ª•: √Åo thun n·ªØ c·ªï tr√≤n"/></div>
          <div><label>SKU (b·∫Øt bu·ªôc cho publish; c√≥ th·ªÉ tr·ªëng khi ch·ªâ upload ·∫£nh)</label><input id="sku" data-clear placeholder="ao-thun-nu-co-tron"/></div>
        </div>
        <div class="row">
          <div><label>Gi√° (VND, kh√¥ng ch·∫•m)</label><input id="price" data-clear type="number" placeholder="399000"/></div>
          <div><label>Merchant</label>
            <select id="merchant">
              <option value="shopee">shopee</option>
              <option value="lazada">lazada</option>
              <option value="tiki">tiki</option>
              <option value="tiktok">tiktok</option>
            </select>
          </div>
        </div>
        <div><label>Link g·ªëc (origin)</label><input id="origin" data-clear placeholder="https://shopee.vn/‚Ä¶"/></div>
        <div class="row">
          <div><label>·∫¢nh (ƒë∆∞·ªùng d·∫´n)</label><input id="image" data-clear placeholder="/assets/img/products/ao-thun-nu-co-tron.webp"/></div>
          <div>
            <label>Danh m·ª•c (category)</label>
            <input id="category" data-clear placeholder="thoi-trang / lam-dep / suc-khoe-the-hinh / me-va-be / nha-cua-doi-song / cong-nghe-phu-kien-thong-minh / qua-tang-cho-phu-nu / blog-chia-se-bi-quyet / sach / trang-suc" list="presetCats"/>
            <datalist id="presetCats">
              <option value="thoi-trang"></option>
              <option value="lam-dep"></option>
              <option value="suc-khoe-the-hinh"></option>
              <option value="me-va-be"></option>
              <option value="nha-cua-doi-song"></option>
              <option value="cong-nghe-phu-kien-thong-minh"></option>
              <option value="qua-tang-cho-phu-nu"></option>
              <option value="blog-chia-se-bi-quyet"></option>
              <option value="sach"></option>
              <option value="trang-suc"></option>
            </datalist>
          </div>
        </div>
        <div><label>Th∆∞∆°ng hi·ªáu (brand)</label><input id="brand" data-clear placeholder="dove, innisfree, wilson‚Ä¶"/></div>
        <div class="row">
          <label style="display:flex;align-items:center;gap:8px;flex:unset"><input type="checkbox" id="featured" style="width:auto"/> N·ªïi b·∫≠t (featured)</label>
          <label style="display:flex;align-items:center;gap:8px;flex:unset"><input type="checkbox" id="status" checked style="width:auto"/> Hi·ªÉn th·ªã (status)</label>
          <button class="btn" id="btnAuto">ƒêi·ªÅn auto t·ª´ t√™n</button>
        </div>
        <div id="diag" class="small"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>2b) H√†ng ƒë·ª£i ·∫£nh (Batch)</h2>
    <div class="row">
      <button class="btn" id="btnConvertAll">Convert t·∫•t c·∫£</button>
      <button class="btn" id="btnDownloadAll">T·∫£i t·∫•t c·∫£</button>
      <button class="btn primary" id="btnUploadAll">Upload t·∫•t c·∫£</button>
      <button class="btn" id="btnClearQueue">üóë Xo√° h√†ng ƒë·ª£i</button>
    </div>
    <div style="overflow:auto;margin-top:10px">
      <table class="queue" id="queueBodyWrap">
        <thead><tr><th>·∫¢nh</th><th>T√™n xu·∫•t</th><th>Th∆∞ m·ª•c</th><th>ƒê·ªãnh d·∫°ng</th><th>ƒê∆∞·ªùng d·∫´n xu·∫•t</th><th>K√≠ch th∆∞·ªõc</th><th>Tr·∫°ng th√°i</th><th>H√†nh ƒë·ªông</th></tr></thead>
        <tbody id="queueBody"></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h2>4) Deep-link</h2>
    <div class="grid g2">
      <div>
        <label>Origin (ƒë√£ nh·∫≠p)</label>
        <textarea id="originOut" class="deeplink-text" readonly></textarea>
        <div class="row" style="margin-top:6px">
          <button class="btn" id="copyOrigin">Copy Origin</button>
          <button class="btn" id="openOrigin">M·ªü Origin</button>
        </div>
      </div>
      <div>
        <label>Affiliate deep-link</label>
        <div class="row">
          <textarea id="deeplink" data-clear placeholder="T·ª± sinh t·ª´ template ho·∫∑c d√°n s·∫µn t·∫°i ƒë√¢y"></textarea>
        </div>
        <div class="row" style="margin-top:6px">
          <button class="btn" id="btnMakeDeeplink">T·∫°o t·ª´ template</button>
          <button class="btn" id="copyDeeplink">Copy Deep-link</button>
          <button class="btn" id="btnOpenDeeplink">M·ªü Deep-link</button>
          <span id="dlCheck" class="badge">‚Äì</span>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>5) JSON xu·∫•t b·∫£n</h2>
    <textarea id="jsonOut" rows="8" spellcheck="false"></textarea>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnToJson">T·∫°o JSON</button>
      <button class="btn" id="btnCopyJson">Copy JSON</button>
      <button class="btn" id="btnDownloadJson">T·∫£i affiliates.append.json</button>
    </div>
  </div>

  <div class="card">
    <h2>6) Worker Debug</h2>
    <div class="row">
      <button class="btn" id="btnProbeOptions">Probe OPTIONS /upload-image</button>
      <button class="btn" id="btnProbePublish">Probe OPTIONS /publish</button>
      <span class="small muted">Log d∆∞·ªõi gi√∫p ph√¢n bi·ªát: CORS / Auth / Payload.</span>
    </div>
    <div id="debugLog" class="small" style="background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px;max-height:220px;overflow:auto">‚Äì</div>
  </div>

  <div class="sticky-actions row">
    <button class="btn primary" id="btnPublish">Publish ‚Üí Store</button>
    <button class="btn" id="btnPublishFeatured">Publish ‚Üí N·ªïi b·∫≠t</button>
    <button class="btn" id="btnVerify">‚úÖ Ki·ªÉm tra tr√™n Store</button>
    <button class="btn" id="btnGenCommit">Gen commit message</button>
    <input id="commitMsg" readonly/>
  </div>

  <div class="toast" id="toast"></div>
</div>

<script>
/* ===== MXD-TOOL v4.4.0-nxp ===== */
function initImporter() {
  const $ = s => document.querySelector(s);

  /* SITE_ID theo hostname */
  const SITE_ID = (() => {
    const h=(location.hostname||'').toLowerCase(); const m=h.match(/^([a-z0-9-]+)/);
    return (m?m[1]:'mxd').replace(/[^a-z0-9-]/g,'')||'mxd';
  })();
  document.title = `${SITE_ID.toUpperCase()} Importer v4.4.0 ‚Äî PRO + Batch + Featured + Debug`;
  const titleEl=$("#title");
  if(titleEl) titleEl.innerHTML = `${SITE_ID.toUpperCase()} Importer v4.4.0 <span class="pill">PRO</span> <span class="pill">Batch</span> <span class="pill">Featured</span> <span class="pill">Debug</span>`;

  const slugify = s => s.toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/ƒë/g,'d').replace(/ƒê/g,'D').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
  const LS_KEY = `MXD_IMPORTER_SETTINGS_V440_${SITE_ID.toUpperCase()}`;

  /* KH√îNG hardcode ID c√° nh√¢n ‚Äî ƒë·ªÉ tr·ªëng n·∫øu ch∆∞a detect */
  const DEFAULT_TPL = '';

  const state = { imgBlob:null, imgName:null, imgW:0, imgH:0 };

  /* UI helpers */
  function toast(msg,cls=''){ const t=$("#toast"); t.innerHTML=msg; t.className='toast show '+cls; setTimeout(()=>t.className='toast',4200); }
  function log(msg){ const d=$("#debugLog"); d.textContent = (d.textContent && d.textContent!=='‚Äì' ? d.textContent + "\n" : "") + msg; d.scrollTop = d.scrollHeight; }
  function showWarn(v){ $("#affWarn").style.display = v ? 'block' : 'none'; }
  function updateToastOffset(){ const bar=document.querySelector('.sticky-actions'); const bottom=bar?(bar.offsetHeight+16):12; document.documentElement.style.setProperty('--toast-bottom', bottom+'px'); }
  updateToastOffset(); window.addEventListener('resize', updateToastOffset);

  /* Theme + quick clears */
  $("#btnMode").onclick=()=>{ document.body.classList.toggle('dark'); $("#btnMode").textContent=document.body.classList.contains('dark')?'Light mode':'Dark mode'; };
  $("#btnClearLog").onclick=()=>{ $("#debugLog").textContent='‚Äì'; toast('ƒê√£ xo√° log.'); };
  $("#btnClearFormQuick").onclick=()=>{ document.querySelectorAll('[data-clear]').forEach(el=>el.value=''); $("#featured").checked=false; $("#status").checked=true; $("#sku").dispatchEvent(new Event('input')); $("#imgPreview").style.display='none'; toast('ƒê√£ xo√° form.'); };

  /* Settings */
  function readSettings(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'{}'); }catch(_){ return {}; } }
  function writeSettings(s){ localStorage.setItem(LS_KEY, JSON.stringify(s)); }
  function uiToSettings(){ return {
    workerUrl:$("#workerUrl").value.trim(),
    xKey:$("#xKey").value.trim(),
    tplShopee:$("#tplShopee").value.trim() || DEFAULT_TPL,
    tplLazada:$("#tplLazada").value.trim() || DEFAULT_TPL,
    tplTiki:$("#tplTiki").value.trim() || DEFAULT_TPL,
    tplTiktok:$("#tplTiktok").value.trim() || DEFAULT_TPL,
    defaultFolder:$("#defaultFolder").value,
    defaultCustomPath:$("#defaultCustomPath").value.trim(),
    defaultFmt:$("#defaultFmt").value
  }; }
  function settingsToUi(s){
    $("#workerUrl").value=s.workerUrl||'';
    $("#xKey").value=s.xKey||'';
    $("#tplShopee").value=s.tplShopee||'';
    $("#tplLazada").value=s.tplLazada||'';
    $("#tplTiki").value=s.tplTiki||'';
    $("#tplTiktok").value=s.tplTiktok||'';
    if(s.defaultFolder) $("#defaultFolder").value=s.defaultFolder;
    if(s.defaultCustomPath) $("#defaultCustomPath").value=s.defaultCustomPath;
    if(s.defaultFmt) $("#defaultFmt").value=s.defaultFmt;
    ensureFolderBase(); updateSingleUploadCta();
    checkAffTemplatesWarn();
  }
  function saveSettings(){ writeSettings(uiToSettings()); $("#settingsStatus").textContent="ƒê√£ l∆∞u."; toast("ƒê√£ l∆∞u c√†i ƒë·∫∑t.","ok"); checkAffTemplatesWarn(); }
  function loadSettings(){ const s=readSettings(); settingsToUi(s); $("#settingsStatus").textContent="ƒê√£ t·∫£i c√†i ƒë·∫∑t."; }
  $("#btnSaveSettings").onclick=saveSettings;
  $("#btnLoadSettings").onclick=loadSettings;
  $("#btnClearSettings").onclick=()=>{ localStorage.removeItem(LS_KEY); settingsToUi({}); $("#settingsStatus").textContent="ƒê√£ x√≥a."; toast('ƒê√£ xo√° c√†i ƒë·∫∑t.'); checkAffTemplatesWarn(); };
  loadSettings();

  /* MXD-ANCHOR:NXP-DEFAULTS ‚Äî √°p m·∫∑c ƒë·ªãnh cho NXPhuong n·∫øu tr·ªëng */
  (function applyNxpDefaults(){
    const s=readSettings();
    const isNxpHost = /(^|\.)nxphuong\.github\.io$/i.test(location.hostname||'') || /nxphuong/i.test(SITE_ID);
    if(isNxpHost){
      if(!s.workerUrl) s.workerUrl = 'https://nxptool.mxd6686.workers.dev';
      if(!s.xKey)      s.xKey      = 'nxp-2025-super';
      writeSettings(s); settingsToUi(s);
    }
  })();

  /* MXD-ANCHOR:AFF-DETECTOR ‚Äî t·ª± ƒë·ªông l·∫•y ID t·ª´ /assets/mxd-affiliate.js */
  async function autodetectAff(){
    $("#affStatus").textContent="ƒêang d√≤ /assets/mxd-affiliate.js‚Ä¶";
    try{
      const r=await fetch('/assets/mxd-affiliate.js',{cache:'no-cache'});
      const txt=await r.text();
      // b·∫Øt t·∫•t c·∫£ deep_link/<aff>/<adv>
      const idRe=/go\.isclix\.com\/deep_link\/(\d+)\/(\d+)/g;
      let firstId=''; const found={};
      for(const m of txt.matchAll(idRe)){
        const aid=m[1], adv=m[2];
        if(!firstId) firstId=aid;
        found[adv]=aid;
      }
      // map ADV chu·∫©n
      const ADV = {
        shopee: '4751584435713464237',
        lazada: '5127144557053758578',
        tiki:   '4348614231480407268',
        tiktok: '6648523843406889655'
      };
      const s=readSettings();
      const aidShopee = found[ADV.shopee] || firstId || '';
      const aidLazada = found[ADV.lazada] || firstId || '';
      const aidTiki   = found[ADV.tiki]   || '';
      const aidTiktok = found[ADV.tiktok] || '';

      if(!(aidShopee||aidLazada||aidTiki||aidTiktok)){
        $("#affStatus").textContent="Kh√¥ng t√¨m ƒë∆∞·ª£c ID trong mxd-affiliate.js. D√°n th·ªß c√¥ng gi√∫p m√¨nh.";
        showWarn(true); return;
      }
      const mk = (aid,adv) => aid ? `https://go.isclix.com/deep_link/${aid}/${adv}?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}` : '';
      const tplShopee = mk(aidShopee, ADV.shopee);
      const tplLazada = mk(aidLazada, ADV.lazada);
      const tplTiki   = mk(aidTiki,   ADV.tiki);
      const tplTiktok = mk(aidTiktok, ADV.tiktok);
      $("#tplShopee").value = tplShopee;
      $("#tplLazada").value = tplLazada;
      $("#tplTiki").value   = tplTiki;
      $("#tplTiktok").value = tplTiktok;
      writeSettings({...s, tplShopee, tplLazada, tplTiki, tplTiktok});
      $("#affStatus").textContent="ƒê√£ ƒëi·ªÅn template t·ª´ mxd-affiliate.js v√† l∆∞u.";
      showWarn(false);
    }catch(e){
      $("#affStatus").textContent="Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c mxd-affiliate.js: "+e.message;
      showWarn(true);
    }
  }
  $("#btnDetectAff").onclick=autodetectAff;

  function checkAffTemplatesWarn(){
    const s=readSettings();
    const bad = (!s.tplShopee && !s.tplLazada && !s.tplTiki && !s.tplTiktok);
    showWarn(bad);
  }

  /* Headers + baseUrl + checks */
  function hdr(method='GET', useKey=true){
    const h={};
    if(['POST','PUT','PATCH'].includes(method)) h['content-type']='application/json';
    const s=readSettings();
    if(useKey && s.xKey) h['x-key']=s.xKey;
    return h;
  }
  async function check(url, useKey=false){
    try{
      const r=await fetch(url,{mode:"cors",cache:"no-cache",headers:hdr('GET',useKey)});
      const text=await r.text().catch(()=>'' );
      return {ok:r.ok,status:r.status,text};
    }catch(e){
      return {ok:false,status:-1,text:String(e)};
    }
  }
  function baseUrl(){ const s=readSettings(); return (s.workerUrl||'').replace(/\/$/,''); }

  $("#btnCheckWorker").onclick=async()=>{ const b=baseUrl(); if(!b){ toast("Ch∆∞a c·∫•u h√¨nh Worker.","warn"); return; } const u=b+"/health"; const r=await check(u,false); const msg=r.ok?`Worker OK (${r.status})`:`Worker l·ªói (${r.status})`; $("#workerStatus").textContent=msg; log("[/health] "+msg+" ‚Äî "+r.text.slice(0,120)); toast(msg, r.ok?"ok":"err"); };
  $("#btnCheckAuth").onclick=async()=>{ const b=baseUrl(); if(!b){ toast("Ch∆∞a c·∫•u h√¨nh Worker.","warn"); return; } const u=b+"/whoami"; const r=await check(u,true); const msg=r.ok?"X-Key h·ª£p l·ªá.":"X-Key kh√¥ng h·ª£p l·ªá ("+r.status+")"; log("[/whoami] "+msg+" ‚Äî "+r.text.slice(0,120)); toast(msg, r.ok?"ok":"err"); };
  $("#btnCheckWrite").onclick=async()=>{ const b=baseUrl(); if(!b){ toast("Ch∆∞a c·∫•u h√¨nh Worker.","warn"); return; } const u=b+"/can-write"; const r=await check(u,true); const msg=r.ok?"C√≥ quy·ªÅn commit.":"Kh√¥ng c√≥ quy·ªÅn ("+r.status+")"; log("[/can-write] "+msg+" ‚Äî "+r.text.slice(0,120)); toast(msg, r.ok?"ok":"err"); };
  $("#btnProbeOptions").onclick=async()=>{ const b=baseUrl(); if(!b){ toast("Ch∆∞a c·∫•u h√¨nh Worker.","warn"); return; } try{ const r=await fetch(b+"/upload-image",{method:"OPTIONS",mode:"cors",cache:"no-cache",headers:hdr('OPTIONS',true)}); log(`[OPTIONS /upload-image] ${r.status}`); toast("Probe OPTIONS /upload-image","ok"); }catch(e){ log("[OPTIONS /upload-image] L·ªói: "+e.message); toast("Probe l·ªói.","err"); } };
  $("#btnProbePublish").onclick=async()=>{ const b=baseUrl(); if(!b){ toast("Ch∆∞a c·∫•u h√¨nh Worker.","warn"); return; } try{ const r=await fetch(b+"/publish",{method:"OPTIONS",mode:"cors",cache:"no-cache",headers:hdr('OPTIONS',true)}); log(`[OPTIONS /publish] ${r.status}`); toast("Probe OPTIONS /publish","ok"); }catch(e){ log("[OPTIONS /publish] L·ªói: "+e.message); toast("Probe l·ªói.","err"); } };
  $("#btnTestUpload").onclick=async()=>{ const b=baseUrl(); if(!b){ toast("Ch∆∞a c·∫•u h√¨nh Worker.","warn"); return; } const c=document.createElement('canvas'); c.width=1; c.height=1; const blob=await new Promise(res=>c.toBlob(res,'image/webp',0.5)); const dataUrl=await blobToDataURL(blob); try{ const r=await fetch(b+'/upload-image',{method:'POST',mode:'cors',cache:"no-cache",headers:hdr('POST',true),body:JSON.stringify({sku:'ping',path:'/assets/img/test/ping.webp',file:dataUrl})}); log(`[TEST UPLOAD] ${r.status} ${r.ok?'OK':'FAIL'}`); toast(r.ok?'Test upload OK':'Test upload FAIL '+r.status, r.ok?'ok':'err'); }catch(e){ log("[TEST UPLOAD] L·ªói: "+e.message); toast("Test upload l·ªói.","err"); } };

  /* Deep-link helpers */
  const vn = s => (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/ƒë/g,'d').replace(/ƒê/g,'D').toLowerCase();
  function normCategory(raw){
    const base = vn(raw).replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'').replace(/-+/g,'-').replace(/^-|-$/g,'');
    if (/^(thoi-trang|ao|quan|vay|hoodie|giay|dep)$/.test(base)) return 'thoi-trang';
    if (/^(lam-dep|my-pham|serum|kem|mask|srm|toner|chong-nang)$/.test(base)) return 'lam-dep';
    if (/^(suc-khoe-the-hinh|tap|protein|may-chay)$/.test(base)) return 'suc-khoe-the-hinh';
    if (/^(me-va-be|ta|bim|sua|binh-sua)$/.test(base)) return 'me-va-be';
    if (/^(nha-cua-doi-song|do-gia-dung|noi-that|trang-tri)$/.test(base)) return 'nha-cua-doi-song';
    if (/^(cong-nghe-phu-kien-thong-minh|dien-thoai|tai-nghe|phu-kien)$/.test(base)) return 'cong-nghe-phu-kien-thong-minh';
    if (/^(qua-tang-cho-phu-nu|qua-tang|gift)$/.test(base)) return 'qua-tang-cho-phu-nu';
    if (/^(blog-chia-se-bi-quyet|blog|tips)$/.test(base)) return 'blog-chia-se-bi-quyet';
    if (/^(sach|book|sach-hay)$/.test(base)) return 'sach';
    if (/^(trang-suc|nhan|vong|day-chuyen|lac|khuyen-tai)$/.test(base)) return 'trang-suc';
    return base||'thoi-trang';
  }
  function computeSubs(sku, merchant){ return { sub1: sku||'sku', sub2:(merchant||'merchant').toLowerCase(), sub3:'tool', sub4:SITE_ID }; }
  function ensureSubsInUrl(u, subs){ const has = k => new RegExp(`[?&]${k}=`,`i`).test(u); const qs=[]; for(const k of ['sub1','sub2','sub3','sub4']) if(!has(k)) qs.push(`${k}=${encodeURIComponent(subs[k])}`); return qs.length?(u+(u.includes('?')?'&':'?')+qs.join('&')):u; }
  function cleanUrl(u){ return (u||'').trim().replace(/^["']+|["',]+$/g,''); }
  function activeTplFor(merchant){
    const s=readSettings();
    if(merchant==='lazada') return s.tplLazada||'';
    if(merchant==='tiki')   return s.tplTiki||'';
    if(merchant==='tiktok') return s.tplTiktok||'';
    return s.tplShopee||'';
  }
  function validateDeeplink(){
    const dl=$("#deeplink").value.trim(); const badge=$("#dlCheck");
    if(!dl){ badge.textContent="ch∆∞a c√≥ deeplink"; badge.className='badge'; return; }
    const okHost=/(^https?:\/\/)?([^/]*\.)?isclix\.com/i.test(dl);
    const hasUrl=/[?&]url=/.test(dl);
    const need=['sub1','sub2','sub3','sub4'];
    const missing=need.filter(k=>!new RegExp(`[?&]${k}=`).test(dl));
    if(okHost && hasUrl && missing.length===0){ badge.textContent="OK affiliate"; badge.className='badge'; return; }
    if(okHost && !hasUrl){ badge.textContent="isclix thi·∫øu url="; badge.className='badge'; return; }
    if(okHost){ badge.textContent="thi·∫øu: "+missing.join(', '); badge.className='badge'; return; }
    badge.textContent="KH√îNG qua affiliate"; badge.className='badge';
  }
  function makeDeeplink(){
    const origin=cleanUrl($("#origin").value.trim()); const sku=$("#sku").value.trim(); const merchant=$("#merchant").value;
    if(!origin){ toast("Thi·∫øu Origin.","warn"); return; }
    const tpl=activeTplFor(merchant);
    if(!tpl){ toast("Ch∆∞a c·∫•u h√¨nh template "+merchant.toUpperCase()+". V√†o C√†i ƒë·∫∑t ƒë·ªÉ ƒëi·ªÅn/auto-detect.", "warn"); showWarn(true); return; }
    const subs=computeSubs(sku,merchant);
    let link=tpl.replace(/\{url\}/g,encodeURIComponent(origin)).replace(/\{sku\}/g,sku||'sku').replace(/\{sub1\}/g,subs.sub1).replace(/\{sub2\}/g,subs.sub2).replace(/\{sub3\}/g,subs.sub3).replace(/\{sub4\}/g,subs.sub4);
    link=ensureSubsInUrl(link,subs);
    $("#deeplink").value=link; validateDeeplink();
  }
  $("#btnMakeDeeplink").onclick=makeDeeplink; $("#deeplink").addEventListener('input', validateDeeplink);
  $("#copyOrigin").onclick=()=>{ const t=$("#originOut"); t.select(); document.execCommand('copy'); toast("ƒê√£ copy Origin.","ok"); };
  $("#openOrigin").onclick=()=>{ const u=$("#originOut").value.trim()||$("#origin").value.trim(); if(u){ window.open(u,'_blank'); } else { toast("Ch∆∞a c√≥ Origin.","warn"); } };
  $("#copyDeeplink").onclick=()=>{ const t=$("#deeplink"); t.select(); document.execCommand('copy'); toast("ƒê√£ copy Deep-link.","ok"); };
  $("#btnOpenDeeplink").onclick=()=>{ const u=$("#deeplink").value.trim(); if(u){ window.open(u,'_blank'); } else { toast("Ch∆∞a c√≥ Deep-link.","warn"); } };

  /* Auto + diag */
  function getSelectedFolder(){ const sel=$("#defaultFolder").value; if(sel==='custom'){ const p=$("#defaultCustomPath").value.trim()||'/assets/img/'; return sanitizeFolder(p); } return sanitizeFolder(sel); }
  function sanitizeFolder(p){ if(!p) return '/assets/img/'; p=p.trim(); if(!p.startsWith('/')) p='/'+p; if(!p.endsWith('/')) p+='/'; return p; }
  function getSelectedFmt(){ return ($("#defaultFmt").value||'webp').toLowerCase(); }
  function extByFmt(fmt){ return fmt==='png'?'.png':'.webp'; }
  function updateSingleUploadCta(){ const folder=getSelectedFolder(); const fmt=getSelectedFmt(); const sku=($("#sku").value.trim()||'<sku>'); $("#btnUploadImg").textContent=`Upload ·∫£nh ‚Üí ${folder}${slugify(sku)}${extByFmt(fmt)}`; }
  function runDiag(){
    const sku=$("#sku").value.trim(); const img=$("#image").value.trim(); const origin=cleanUrl($("#origin").value.trim()); const merchant=$("#merchant").value;
    const expectedFolder=getSelectedFolder(); const fmt=getSelectedFmt(); const msgs=[];
    if(!sku) msgs.push("‚Ä¢ Thi·∫øu SKU (b·∫Øt bu·ªôc cho publish).");
    if(img && !img.startsWith(`${expectedFolder}${sku||'...'}`)) msgs.push("‚Ä¢ ·∫¢nh n√™n l√† "+expectedFolder+(sku||'<sku>')+extByFmt(fmt));
    if(origin && !/shopee\.vn|lazada\.vn|tiktok\.com|tiki\.vn/i.test(origin)) msgs.push("‚Ä¢ Origin kh√¥ng ph·∫£i Shopee/Lazada/TikTok/Tiki.");
    msgs.push("‚Ä¢ Merchant: "+merchant);
    $("#diag").innerHTML=msgs.length?msgs.map(x=>`<div>${x}</div>`).join(""):'<span class="ok">T·∫°m ·ªïn.</span>';
    $("#originOut").value=origin;
  }
  $("#btnAuto").onclick=()=>{ const name=$("#name").value.trim(); const skuNow=$("#sku").value.trim(); if(name && !skuNow) $("#sku").value=slugify(name); const folder=getSelectedFolder(); const baseSku=$("#sku").value.trim()||'...'; const fmt=getSelectedFmt(); if($("#sku").value && !$("#image").value) $("#image").value=`${folder}${slugify(baseSku)}${extByFmt(fmt)}`; const g=autoCategory(`${name} ${$("#brand").value} ${$("#origin").value}`); if(g && !$("#category").value.trim()) $("#category").value=g; runDiag(); updateSingleUploadCta(); };
  ["name","sku","origin","image","merchant"].forEach(id=>$("#"+id).addEventListener('input', ()=>{ runDiag(); if(id==='sku') updateSingleUploadCta(); }));
  $("#defaultFolder").addEventListener('change', ()=>{ ensureFolderBase(); updateSingleUploadCta(); saveSettings(); });
  $("#defaultCustomPath").addEventListener('input', ()=>{ updateSingleUploadCta(); saveSettings(); });
  $("#defaultFmt").addEventListener('change', ()=>{ saveSettings(); updateSingleUploadCta(); });

  function ensureFolderBase(){ const sel=$("#defaultFolder").value; $("#defaultCustomWrap").style.display = (sel==='custom')?'block':'none'; if(sel!=='custom') return; if(!$("#defaultCustomPath").value.trim()) $("#defaultCustomPath").value="/assets/img/"; }
  ensureFolderBase(); updateSingleUploadCta();

  /* Image & batch (nh∆∞ b·∫£n g·ªëc) */
  const drop=$("#drop"), file=$("#file"), thumb=$("#thumb"), imgName=$("#imgName"), imgInfo=$("#imgInfo");
  drop.addEventListener('click', ()=>file.click());
  $("#btnSelectImg").onclick=()=>file.click();
  drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('dragover'); });
  drop.addEventListener('dragleave', ()=>drop.classList.remove('dragover'));
  drop.addEventListener('drop', e=>{ e.preventDefault(); drop.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
  file.onchange=e=>handleFiles(e.target.files);

  function baseNameWithoutExt(filename){ const s=(filename||'').split('/').pop(); const i=s.lastIndexOf('.'); return (i>0?s.slice(0,i):s); }
  function decideNameFor(file){ const sku=$("#sku").value.trim(); const useFilename=$("#cbUseFilename").checked; if(sku) return slugify(sku); if(useFilename && file && file.name) return slugify(baseNameWithoutExt(file.name)); const nm=$("#name").value.trim(); if(nm) return slugify(nm); return 'tt'; }
  function handleFiles(files){ if(!files || !files.length) return; if(files.length===1){ handleSingleFile(files[0]); } else { for(const f of files){ queueAddRawFile(f); } toast(`ƒê√£ th√™m ${files.length} ·∫£nh v√†o h√†ng ƒë·ª£i.`,'ok'); } }
  function handleSingleFile(f){ const reader=new FileReader(); reader.onload=ev=>{ const img=new Image(); img.onload=()=>{ const maxSide=1200; const scale=Math.min(1, maxSide/Math.max(img.width,img.height)); const w=Math.round(img.width*scale), h=Math.round(img.height*scale); const canvas=document.createElement('canvas'); canvas.width=w; canvas.height=h; canvas.getContext('2d').drawImage(img,0,0,w,h); canvas.toBlob(blob=>{ state.imgBlob=blob; state.imgW=w; state.imgH=h; const base=decideNameFor(f); const fmt=getSelectedFmt(); state.imgName=`${base}${extByFmt(fmt)}`; const folder=getSelectedFolder(); $("#image").value=`${folder}${base}${extByFmt(fmt)}`; $("#imgPreview").style.display='flex'; thumb.src=URL.createObjectURL(blob); imgName.textContent=state.imgName; imgInfo.textContent=`${w}√ó${h}, ${(blob.size/1024).toFixed(1)} KB`; updateSingleUploadCta(); }, 'image/webp', 0.82); }; img.src=ev.target.result; }; reader.readAsDataURL(f); }

  const queue=[]; let seq=0;
  async function queueAddRawFile(file){ const name=decideNameFor(file); const fmt=$("#defaultFmt").value||'webp'; let folder=getSelectedFolder(); const item={ id:(++seq), srcFile:file, name, fmt, folder, customPath:$("#defaultFolder").value==='custom', outBlob:null, w:0, h:0, status:'pending' }; queue.push(item); await queueProcess(item); renderQueue(); }
  async function queueProcess(it){ if(it.outBlob && it.w && it.h){ it.status='ready'; return; } if(!it.srcFile){ it.status='error'; return; } it.status='processing'; const dataUrl=await readFileAsDataURL(it.srcFile); const img=document.createElement('img'); await new Promise(r=>{ img.onload=r; img.src=dataUrl; }); const maxSide=1200; const scale=Math.min(1, maxSide/Math.max(img.width,img.height)); const w=Math.round(img.width*scale), h=Math.round(img.height*scale); const canvas=document.createElement('canvas'); canvas.width=w; canvas.height=h; canvas.getContext('2d').drawImage(img,0,0,w,h); const mime=it.fmt==='png'?'image/png':'image/webp'; const quality=it.fmt==='png'?1.0:0.82; it.outBlob=await new Promise(res=>canvas.toBlob(res,mime,quality)); it.w=w; it.h=h; it.status='ready'; }
  function renderQueue(){ const tbody=$("#queueBody"); if(!queue.length){ tbody.innerHTML='<tr><td colspan="8" class="muted">Ch∆∞a c√≥ g√¨ trong h√†ng ƒë·ª£i.</td></tr>'; return; } tbody.innerHTML=queue.map(it=>{ const url=it.outBlob?URL.createObjectURL(it.outBlob):''; const status=it.status==='ready'?'S·∫µn s√†ng':(it.status==='processing'?'ƒêang x·ª≠ l√Ω':(it.status==='uploaded'?'ƒê√£ upload':(it.status==='error'?'L·ªói':'Ch·ªù'))); return `<tr data-id="${it.id}"><td><div class="mini">${ url ? `<img class="thumb" src="${url}" alt="thumb">` : '' }</div></td><td><input class="name" value="${it.name}"/></td><td><select class="folder"><option value="/assets/img/products/" ${it.folder==="/assets/img/products/"?'selected':''}>/assets/img/products/</option><option value="/assets/img/categories/" ${it.folder==="/assets/img/categories/"?'selected':''}>/assets/img/categories/</option><option value="/assets/img/og/" ${it.folder==="/assets/img/og/"?'selected':''}>/assets/img/og/</option><option value="/assets/img/brands/" ${it.folder==="/assets/img/brands/"?'selected':''}>/assets/img/brands/</option><option value="custom" ${it.customPath?'selected':''}>T·ª± nh·∫≠p‚Ä¶</option></select><input class="customPath" placeholder="/assets/img/blog/2025/" style="margin-top:6px;display:${it.customPath?'block':'none'}" value="${it.customPath?it.folder:''}"/></td><td><select class="fmt"><option value="webp" ${it.fmt==='webp'?'selected':''}>webp</option><option value="png" ${it.fmt==='png'?'selected':''}>png</option></select></td><td class="nowrap">${pathFor(it)}</td><td>${it.w||'‚Äì'}√ó${it.h||'‚Äì'}<div class="small muted">${it.outBlob? (it.outBlob.size/1024|0)+' KB':''}</div></td><td class="status">${status}</td><td class="controls"><button class="btn sm do-convert">Convert</button><button class="btn sm do-download">T·∫£i</button><button class="btn sm do-upload">Upload</button><button class="btn sm do-remove">Xo√°</button></td></tr>`; }).join(''); tbody.querySelectorAll('tr').forEach(tr=>{ const id=Number(tr.getAttribute('data-id')); const it=queue.find(x=>x.id===id); const nameInput=tr.querySelector('.name'); const folderSel=tr.querySelector('.folder'); const customInput=tr.querySelector('.customPath'); const fmtSel=tr.querySelector('.fmt'); const pathCell=tr.children[4]; const statusEl=tr.querySelector('.status'); nameInput.oninput=()=>{ it.name=slugify(nameInput.value||'tt'); pathCell.textContent=pathFor(it); }; folderSel.onchange=()=>{ if(folderSel.value==='custom'){ it.customPath=true; customInput.style.display='block'; if(customInput.value.trim()==='') customInput.value='/assets/img/'; it.folder=sanitizeFolder(customInput.value.trim()); } else { it.customPath=false; customInput.style.display='none'; it.folder=folderSel.value; } pathCell.textContent=pathFor(it); }; customInput.oninput=()=>{ it.folder=sanitizeFolder(customInput.value.trim()); pathCell.textContent=pathFor(it); }; fmtSel.onchange=async()=>{ it.fmt=fmtSel.value; pathCell.textContent=pathFor(it); await queueProcess(it); statusEl.textContent='S·∫µn s√†ng'; renderQueue(); }; tr.querySelector('.do-remove').onclick=()=>{ const idx=queue.findIndex(x=>x.id===id); if(idx>=0){ queue.splice(idx,1); renderQueue(); } }; tr.querySelector('.do-convert').onclick=async()=>{ statusEl.textContent='ƒêang x·ª≠ l√Ω'; await queueProcess(it); statusEl.textContent='S·∫µn s√†ng'; renderQueue(); }; tr.querySelector('.do-download').onclick=()=>{ if(!it.outBlob){ toast("Ch∆∞a convert.","warn"); return; } const a=document.createElement('a'); a.href=URL.createObjectURL(it.outBlob); a.download=it.name+'.'+(it.fmt||'webp'); a.click(); }; tr.querySelector('.do-upload').onclick=()=>uploadItem(it, statusEl); }); }
  function pathFor(it){ let base=sanitizeFolder(it.folder||'/assets/img/'); const ext='.'+(it.fmt||'webp').toLowerCase(); return base+it.name+ext; }
  function readFileAsDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
  function blobToDataURL(blob){ return new Promise(res=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(blob); }); }
  function splitDataUrl(d){ const m = String(d||'').match(/^data:([^;]+);base64,(.+)$/); return m ? { mime:m[1], base64:m[2] } : { mime:'', base64:d||'' }; }
  async function transcodeBlob(blob, fmt, w, h){ const url=URL.createObjectURL(blob); const img=new Image(); await new Promise(r=>{ img.onload=r; img.src=url; }); const c=document.createElement('canvas'); c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h); const mime = fmt==='png' ? 'image/png' : 'image/webp'; const quality = fmt==='png' ? 1.0 : 0.82; return await new Promise(res=>c.toBlob(res, mime, quality)); }
  async function uploadItem(it, statusEl){ let path=pathFor(it); try{ if(!it.outBlob){ statusEl.textContent='ƒêang x·ª≠ l√Ω'; await queueProcess(it); } const b=baseUrl(); if(!b){ toast("Ch∆∞a c·∫•u h√¨nh Worker.","warn"); return; } const dataUrl=await blobToDataURL(it.outBlob); statusEl.textContent='Uploading‚Ä¶'; let r=await fetch(b+"/upload-image",{method:"POST",mode:"cors",cache:"no-cache",headers:hdr('POST',true),body:JSON.stringify({ sku:it.name, path, file:dataUrl })}); let text=await r.text().catch(()=>'' ); if(!r.ok){ log(`[upload ${path}] FAIL ${r.status}. Th·ª≠ base64 thu·∫ßn‚Ä¶ ‚Äî ${text.slice(0,140)}`); const {mime, base64} = splitDataUrl(dataUrl); r=await fetch(b+"/upload-image",{method:"POST",mode:"cors",cache:"no-cache",headers:hdr('POST',true),body:JSON.stringify({ sku:it.name, path, file:base64, mime })}); text=await r.text().catch(()=>'' ); } if(!r.ok && it.fmt!=='webp'){ log(`[upload ${path}] FAIL n·ªØa. Fallback WebP‚Ä¶`); const webpBlob=await transcodeBlob(it.outBlob, 'webp', it.w||1200, it.h||1200); const newDataUrl=await blobToDataURL(webpBlob); const newPath=path.replace(/\.png$/i,'.webp'); r=await fetch(b+"/upload-image",{method:"POST",mode:"cors",cache:"no-cache",headers:hdr('POST',true),body:JSON.stringify({ sku:it.name, path:newPath, file:newDataUrl })}); text=await r.text().catch(()=>'' ); if(r.ok){ it.fmt='webp'; it.outBlob=webpBlob; path=newPath; } } if(!r.ok){ statusEl.textContent='L·ªói upload'; log(`[upload ${path}] FAIL cu·ªëi ${r.status}: ${text.slice(0,200)}`); toast("Upload l·ªói "+r.status,"err"); return; } statusEl.textContent='ƒê√£ upload'; it.status='uploaded'; log(`[upload ${path}] OK`); const sku=$("#sku").value.trim(); if(sku && it.name===slugify(sku)) $("#image").value=path; }catch(e){ statusEl.textContent='L·ªói upload'; log(`[upload ${path}] EXC: ${e.message}`); toast("Upload l·ªói: "+e.message,"err"); } }

  $("#btnClearQueue").onclick=()=>{ queue.length=0; renderQueue(); toast('ƒê√£ xo√° h√†ng ƒë·ª£i.'); };
  $("#btnConvertAll").onclick=async()=>{ for(const it of queue){ await queueProcess(it); } toast("ƒê√£ convert t·∫•t c·∫£.","ok"); renderQueue(); };
  $("#btnDownloadAll").onclick=()=>{ for(const it of queue){ if(!it.outBlob) continue; const a=document.createElement('a'); a.href=URL.createObjectURL(it.outBlob); a.download=it.name+'.'+(it.fmt||'webp'); a.click(); } };
  $("#btnUploadAll").onclick=async()=>{ const b=baseUrl(); if(!b){ toast("Ch∆∞a c·∫•u h√¨nh Worker.","warn"); return; } for(const it of queue){ const row=document.querySelector(`tr[data-id="${it.id}"] .status`); await uploadItem(it,row); } toast("Upload t·∫•t c·∫£ xong (xem tr·∫°ng th√°i t·ª´ng m·ª•c).","ok"); };

  /* Single upload */
  $("#btnConvert").onclick=()=>{ if(!state.imgBlob){ toast("Ch∆∞a ch·ªçn ·∫£nh.","warn"); return; } toast("ƒê√£ n√©n .webp s·∫µn.","ok"); };
  $("#btnSaveImg").onclick=()=>{ if(!state.imgBlob){ toast("Ch∆∞a c√≥ ·∫£nh.","warn"); return; } const a=document.createElement('a'); a.href=URL.createObjectURL(state.imgBlob); a.download=state.imgName||'product.webp'; a.click(); };
  $("#btnUploadImg").onclick=async()=>{ if(!state.imgBlob){ toast("Ch∆∞a c√≥ ·∫£nh.","warn"); return; } const b=baseUrl(); if(!b){ toast("Ch∆∞a c·∫•u h√¨nh Worker.","warn"); return; } const sku=($("#sku").value.trim()||'tt'); const folder=getSelectedFolder(); const fmt=getSelectedFmt(); const path=`${folder}${slugify(sku)}${extByFmt(fmt)}`; let blob=state.imgBlob; try{ if(fmt==='png'){ blob = await transcodeBlob(state.imgBlob,'png', state.imgW||1200, state.imgH||1200); } const dataUrl=await blobToDataURL(blob); let r=await fetch(b+"/upload-image",{method:"POST",mode:"cors",cache:"no-cache",headers:hdr('POST',true),body:JSON.stringify({ sku:slugify(sku), path, file:dataUrl })}); let text=await r.text().catch(()=>'' ); if(!r.ok){ const {mime, base64} = splitDataUrl(dataUrl); r=await fetch(b+"/upload-image",{method:"POST",mode:"cors",cache:"no-cache",headers:hdr('POST',true),body:JSON.stringify({ sku:slugify(sku), path, file:base64, mime })}); text=await r.text().catch(()=>'' ); } log(`[single upload ${path}] ${r.status} ${r.ok?'OK':'FAIL'} ‚Äî ${text.slice(0,160)}`); toast(r.ok?"ƒê√£ upload ·∫£nh l√™n repo.":"Upload ·∫£nh l·ªói "+r.status, r.ok?"ok":"err"); if(r.ok) $("#image").value=path; }catch(e){ log("[single upload] EXC: "+e.message); toast("Upload ·∫£nh l·ªói: "+e.message,"err"); } };

  /* Build JSON & publish */
  function buildJson(){ if(!$("#category").value.trim()){ const text=`${$("#name").value} ${$("#brand").value} ${$("#origin").value}`; const guess=autoCategory(text); if(guess) $("#category").value=guess; } $("#category").value=normCategory($("#category").value); const now=new Date().toISOString(); const obj={ name:$("#name").value.trim(), price_vnd:Number($("#price").value||0), origin_url:cleanUrl($("#origin").value.trim()), merchant:$("#merchant").value, sku:$("#sku").value.trim(), image:$("#image").value.trim(), category:$("#category").value.trim(), brand:$("#brand").value.trim(), featured:$("#featured").checked, status:$("#status").checked, updated_at:now }; const dl=$("#deeplink").value.trim(); if(dl) obj.deeplink=dl; $("#jsonOut").value=JSON.stringify([obj],null,2); return obj; }
  $("#btnToJson").onclick=buildJson;
  $("#btnCopyJson").onclick=()=>{ $("#jsonOut").select(); document.execCommand('copy'); toast("ƒê√£ copy JSON."); };
  $("#btnDownloadJson").onclick=()=>{ if(!$("#jsonOut").value) buildJson(); const blob=new Blob([$("#jsonOut").value],{type:"application/json"}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='affiliates.append.json'; a.click(); };

  $("#btnPublish").onclick=()=>doPublish(false);
  $("#btnPublishFeatured").onclick=()=>doPublish(true);

  async function doPublish(forceFeatured){ const obj=buildJson(); if(forceFeatured){ obj.featured=true; $("#featured").checked=true; $("#jsonOut").value=JSON.stringify([obj],null,2); } if(!obj.sku){ toast("Thi·∫øu SKU.","err"); return; } if(!obj.origin_url){ toast("Thi·∫øu origin.","warn"); return; } if(!$("#deeplink").value.trim()){ const maybe=activeTplFor($("#merchant").value); if(maybe){ makeDeeplink(); const dl=$("#deeplink").value.trim(); if(dl){ obj.deeplink=dl; $("#jsonOut").value=JSON.stringify([obj],null,2); } } else { showWarn(true); toast("Ch∆∞a c√≥ template affiliate. V√†o C√†i ƒë·∫∑t ƒë·ªÉ c·∫•u h√¨nh.", "warn"); return; } } const b=baseUrl(); if(b){ try{ const r=await fetch(b+"/publish",{method:"POST",mode:"cors",cache:"no-cache",headers:hdr('POST',true),body:JSON.stringify(obj)}); const text=await r.text().catch(()=>'' ); log(`[publish ${obj.sku}] ${r.status} ${r.ok?'OK':'FAIL'} ‚Äî ${text.slice(0,200)}`); if(!r.ok) throw new Error('HTTP '+r.status); toast("Publish OK ‚Üí store"+(obj.featured?" + n·ªïi b·∫≠t":""),"ok"); window.scrollTo({top:0,behavior:'smooth'}); return; }catch(e){ toast("Publish l·ªói (auto t·∫£i JSON ƒë·ªÉ commit tay): "+e.message,"err"); } } const blob=new Blob([JSON.stringify([obj],null,2)],{type:"application/json"}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='affiliates.append.json'; a.click(); }

  /* Verify */
  $("#btnVerify").onclick=async()=>{ const sku=$("#sku").value.trim(); if(!sku){ toast("Ch∆∞a c√≥ SKU ƒë·ªÉ ki·ªÉm tra.","warn"); return; } try{ const r=await fetch('/assets/data/affiliates.json?_='+Date.now(),{cache:'no-cache'}); const arr=await r.json(); const list = Array.isArray(arr)?arr:(arr.items||[]); const found=list.some(x=>(String(x.sku||'').toLowerCase())===sku.toLowerCase()); toast(found?"ƒê√É C√ì trong affiliates.json.":"CH∆ØA TH·∫§Y trong affiliates.json.", found?"ok":"warn"); }catch(e){ toast("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c assets/data/affiliates.json: "+e.message, "err"); } const url=`/store.html?dev=1&sku=${encodeURIComponent(sku)}&v=${Date.now()}`; window.open(url,'_blank'); };

  /* Commit message generator */
  $("#btnGenCommit").onclick=()=>{ const sku = ($("#sku").value||'').trim(); const name = ($("#name").value||'').trim(); const cat = ($("#category").value||'').trim() || 'thoi-trang'; const feat = $("#featured").checked; const hasImg = ($("#image").value||'').trim(); const msg = `feat(product): add ${sku||'sku'} "${name||'Product'}" (cat=${cat})${feat?' [featured]':''}${hasImg?' + image':''}`; $("#commitMsg").value = msg; $("#commitMsg").select(); document.execCommand('copy'); toast("ƒê√£ t·∫°o & copy commit message.","ok"); };

  /* Utilities */
  function autoCategory(text){ const t=vn(text);
    if(/\b(ao|√°o|quan|qu·∫ßn|v√°y|hoodie|giay|gi√†y|dep|d√©p)\b/i.test(text)) return 'thoi-trang';
    if(/\b(l√†m\s*ƒë·∫πp|my\s*pham|serum|kem|mask|srm|toner|chong\s*nang)\b/i.test(text)) return 'lam-dep';
    if(/\b(suc\s*khoe|the\s*hinh|tap|protein|may\s*chay)\b/i.test(text)) return 'suc-khoe-the-hinh';
    if(/\b(b·ªâm|t√£|s·ªØa|b√¨nh\s*s·ªØa)\b/i.test(text)) return 'me-va-be';
    if(/\b(nh√†\s*c·ª≠a|ƒë·ªùi\s*s·ªëng|gia\s*d·ª•ng|n·ªìi|b·∫øp)\b/i.test(text)) return 'nha-cua-doi-song';
    if(/\b(ƒëi·ªán\s*tho·∫°i|tai\s*nghe|ph·ª•\s*ki·ªán|c√¥ng\s*ngh·ªá)\b/i.test(text)) return 'cong-nghe-phu-kien-thong-minh';
    if(/\b(qu√†\s*t·∫∑ng|ph·ª•\s*n·ªØ|gift)\b/i.test(text)) return 'qua-tang-cho-phu-nu';
    if(/\b(blog|chia\s*s·∫ª|b√≠\s*quy·∫øt|tips)\b/i.test(text)) return 'blog-chia-se-bi-quyet';
    if(/\b(s√°ch|book)\b/i.test(text)) return 'sach';
    if(/\b(d√¢y\s*chuy·ªÅn|nh·∫´n|v√≤ng|l·∫Øc|khuy√™n\s*tai)\b/i.test(text)) return 'trang-suc';
    return '';
  }

  /* Auto-detect m·ªôt l·∫ßn khi m·ªü n·∫øu ch∆∞a c√≥ template */
  (function initAffOnce(){
    const s=readSettings();
    if(!(s.tplShopee||s.tplLazada||s.tplTiki||s.tplTiktok)){
      showWarn(true);
      autodetectAff();
    }
  })();

  // initial render
  renderQueue();
}

/* Boot ngay c·∫£ khi DOMContentLoaded ƒë√£ b·∫Øn tr∆∞·ªõc ƒë√≥ */
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initImporter);
} else {
  initImporter();
}
</script>
<!-- debrand + SAFE: kh√¥ng hardcode ID; c√≥ autodetect + c·∫£nh b√°o; tiki support -->
</body>
</html>
